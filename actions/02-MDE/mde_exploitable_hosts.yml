Name: Hosts with public available code for CVE
ID: MDE_Exploitable_Hosts
Description: Find hosts in MDE with exploitable software
Author: FalconForce
Version: '1.0'
Info: |-
Active: true                 # Enable to run this action
Debug: false                  # Enable to see query results in the console
SourcePlatform: MDE          # Sentinel, Watchlist, Neo4j, CSV, MDE, Graph, Splunk
Query: |
    let Timestamp = datetime(now)-1d;
    let vulnerablesoftware=DeviceTvmSoftwareVulnerabilities 
    | where isempty(CveId)==false;
    let exploitable=DeviceTvmSoftwareVulnerabilitiesKB 
    | where CveId in ((vulnerablesoftware|project CveId))
    | where IsExploitAvailable == "1";
    let machinesToPatch=vulnerablesoftware
    | join exploitable on CveId
    | summarize SoftwareNames=tostring(make_set(SoftwareName)),CveIds=tostring(make_set(CveId)) by DeviceId;
    DeviceInfo
    | summarize arg_max(Timestamp,*) by DeviceId
    | join kind=inner machinesToPatch on DeviceId
    | where isnotempty(DeviceName) // Added to prevent an error when DeviceName is empty. This happens on Linux devices, for example.
    | where DeviceName !contains " " // Added to prevent an error when DeviceName has a space in it. This happens on phones, for example.
    | extend DeviceName=toupper(DeviceName)
    | project Timestamp,DeviceName, OSPlatform,IsAzureADJoined,JoinType,DeviceType,IsInternetFacing,ExposureLevel,SoftwareNames,CveIds
# Targets are the platforms that this action will push to (CSV, Neo4j, Sentinel, Wachlist, Slack, Teams, Splunk, Markdown)
Targets:
  - Name: Neo4j
    Enabled: true
    Query: |
      MATCH (c:Computer {name:$DeviceName}) SET c.exploitable = true, c.exploits = $CveIds, c.exploitableSince = $Timestamp
    Parameters:
      DeviceName: DeviceName
      CveIds: CveIds
      Timestamp: Timestamp
  - Name: Watchlist
    Enabled: true
    WatchlistName: FH_MDE_Exploitable_Machines
    DisplayName: MDE Exploitable Machines
    SearchKey: DeviceName
    Overwrite: true