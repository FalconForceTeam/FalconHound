Name: N4J exploitable device with path to high-value nodes
ID: N4J_Exploitable_Device_to_HighValue
Description: Counts all direct and nested shortest paths to high-value nodes from devices that have vulnerabilities that have publicly available exploits.
Author: FalconForce
Version: '1.0'
Info: |-
Active: true                 # Enable to run this action
Debug: false                   # Enable to see query results in the console
SourcePlatform: Neo4j 
Query: |
  MATCH (x:Group)
  WHERE (coalesce(x.system_tags,"") CONTAINS "admin_tier_0" or x.highvalue=true)
  WITH  x.objectid as ObjectID, x.name as Name
  MATCH (y:Group {objectid:ObjectID})
  MATCH (u:Computer {exploitable:true})
  WITH Name, COUNT(shortestPath((u)-[]->(y))) as Direct, COUNT(shortestPath((u)-[*1..]->(y))) as Nested, nodes(shortestPath((u)-[]->(y))) as DirectNames, nodes(shortestPath((u)-[*1..]->(y))) as NestedNames
  WHERE Nested <> 0 or Direct <> 0
  RETURN {Name: Name, Direct: Direct, DirectNames: [node in DirectNames | node.name],Nested: Nested, NestedNames: [node in NestedNames | node.name]} as info
Targets:
  - Name: CSV
    Enabled: false
    Path: output/exploitable_to_highvaluecount.csv
  - Name: Sentinel
    BHQuery: |
      MATCH (x:Group)
      WHERE (coalesce(x.system_tags,"") CONTAINS "admin_tier_0" or x.highvalue=true)
      WITH  x.objectid as ObjectID, x.name as Name
      MATCH (y:Group {objectid:ObjectID})
      MATCH (u:Computer {exploitable:true})
      MATCH a=shortestPath((u)-[*1..4]->(y)) RETURN a
    Enabled: true
  - Name: Watchlist
    Enabled: true
    WatchlistName: FH_Exploitable_Device_to_HighValue
    DisplayName: Exploitable Device to HighValue
    SearchKey: Name
    Overwrite: true
  - Name: ADX
    Enabled: false
    Table: FalconHound
  - Name: Markdown
    Enabled: true
    Path: report/{{date}}/exploitable_to_highvaluecount.md